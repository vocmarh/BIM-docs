# План реализации (WBS)

## Фаза 0. Каркас

- **Схема БД**  
  Используется существующая отработанная схема выгрузки Revit → MSSQL (таблицы `EL_Элементы`, `EL_EAV` и др.), применяемая на всех проектах. Дополнительного проектирования базы данных не требуется.  

- **Роли пользователей**  
  - **БИМ-отдел**  
    - отвечает за выгрузку параметров в БД;  
    - на первом этапе заполняет параметр `TOUCH_Классификатор`.  
  - **Проектировщик** (планируется в будущем)  
    - будет заполнять параметр `TOUCH_Классификатор`.  
  - **Начальник участка / ПТО**  
    - в Revit вручную заполняет `TOUCH_Фактическая_дата_начала`;  
    - в Revit вручную заполняет `TOUCH_Фактическая_дата_завершения`.  
  - **Инструмент (плагин)**  
    - автоматически заполняет `TOUCH_Плановая_дата_начала`;  
    - автоматически заполняет `TOUCH_Плановая_дата_завершения`;  
    - источником данных является ГПР и параметр `TOUCH_Классификатор`.  


## Фаза 1. Данные и модель

### Новые параметры в Revit:

- `TOUCH_Фактическая_дата_начала` — **начальник участка** (ручной ввод).  
- `TOUCH_Фактическая_дата_завершения` — **начальник участка** (ручной ввод).  
- `TOUCH_Плановая_дата_начала` — **плагин** (автоматическое заполнение на основе ГПР и классификатора).  
- `TOUCH_Плановая_дата_завершения` — **плагин** (автоматическое заполнение на основе ГПР и классификатора).  
- `TOUCH_Классификатор` — на первом этапе **БИМ-отдел**, в дальнейшем **проектировщик**.  

### Логика работы:

1. При выгрузке данных из Revit параметры сохраняются в существующую схему БД (EL_Элементы, EL_EAV).  
2. Начальник участка отвечает только за фактические даты.  
3. Плановые даты подтягиваются автоматически, исключая ручной ввод.  
4. Классификатор — ключ для сопоставления элементов с ГПР.  

## Фаза 2. Связка с ГПР (плагин + MSSQL)

**Цель:** подгружать плановые даты из ГПР (MS Project → Excel) в БД с версионированием и заполнять ими параметры элементов в Revit.

### Источник данных
- Экспорт из MS Project в **Excel** (CSV/XLSX).
- Обязательные поля (в Excel могут называться иначе, важно содержание):
  - `ClassifierCode` — код по классификатору (ключ связи с элементом);
  - `TaskName` — название задачи;
  - `StartDate` / `FinishDate` — плановые даты;
  - (опц.) `WBS`, `TaskUID`, `BaselineStart`, `BaselineFinish`, `IsMilestone`.

### Схема данных в MSSQL (минимум)
- **ScheduleVersion** — реестр версий ГПР  
  - `VersionId` (PK, авто)  
  - `SourceFile` (имя/путь Excel)  
  - `VersionTag` (например, `GPR_2025-10-03_v3`)  
  - `ImportedAtUtc` (дата импорта)

- **ScheduleBindings** — строки ГПР для конкретной версии  
  - `VersionId` (FK → ScheduleVersion)  
  - `ClassifierCode` (ключ связи с элементами Revit)  
  - `TaskName`, (опц.) `WBS`, `TaskUID`  
  - `StartDate` (DATE), `FinishDate` (DATE)  
  - (опц.) `BaselineStart`, `BaselineFinish`, `IsMilestone`

> Тип дат — **DATE** (без времени), чтобы исключить путаницу с часовыми поясами.

### Политика версий
- По умолчанию **активной** считается **последняя импортированная версия** (`MAX(VersionId)`).  
- В плагине предусмотрено два режима:  
  - **Auto** — применять плановые даты из последней версии;  
  - **Manual** — пользователь выбирает конкретный `VersionId` из списка версий.

### Процесс (логика)
1. Пользователь выбирает Excel-файл ГПР.  
2. Плагин парсит Excel и:  
   - создаёт запись в **ScheduleVersion** (фиксирует файл и тег версии);  
   - загружает строки в **ScheduleBindings**.  
3. Плагин формирует словарь **`ClassifierCode → (StartDate, FinishDate)`**.  
4. Плагин проходит по элементам модели:  
   - берёт `TOUCH_Классификатор`;  
   - если код найден — записывает:  
     - `TOUCH_Плановая_дата_начала` = `StartDate`,  
     - `TOUCH_Плановая_дата_завершения` = `FinishDate`,  
     - (опц.) `TOUCH_ГПР_Версия` = `v{VersionId}` / `VersionTag`.  
5. История импортов сохраняется в БД, в модели фиксируется версия, по которой заполнены даты.

### Валидация
- **Пустые или некорректные коды** — пропускаются, в отчёт попадает количество строк.  
- **Дубли по одному коду** — политика:  
  - брать самую детализированную запись (`WBS` глубже), или  
  - фиксировать правило (первая/последняя по порядку).  
- **Нет кода в модели** — элемент пропускается.  
- **Неверные даты** (`StartDate > FinishDate`) — строка игнорируется, попадает в отчёт.

### Роли
- **БИМ-отдел** — готовит Excel-выгрузку и запускает импорт, контролирует качество кодов.  
- **Плагин** — импортирует (создаёт версию), сопоставляет по `TOUCH_Классификатор`, записывает плановые даты и метку версии.  
- **Power BI** (опционально) — использует таблицы `ScheduleVersion` и `ScheduleBindings` для отчётов и анализа версий.

### Почему так
- Централизованная история версий и аудит (какой файл и когда загружен).  
- Простая логика в Revit: элементы получают даты из стабильного слоя данных.  
- Готово к автоматизации в будущем (например, через n8n без изменения работы плагина).


## Фаза 3. Обновления моделей
- Перенос параметров `TOUCH_*` из старой модели в новую (по `ElementGuid`/геометрическим сигнатурам).

## Фаза 4. Визуализация (Power BI RS)
- Витрины `vw_Elements`, `vw_PlanFact`, `vw_StatusAgg`.
- 3D раскраска статусов, таймлайн, KPI по объёмам/отклонениям.

## Фаза 5. UX и обучение
- Dockable Pane с минимумом действий.
- Памятка 1‑страница и 5‑мин. видео.

## Фаза 6. Автоматизация (n8n)
- Ежедневный снапшот и KPI в Telegram.
- Импорт ГПР, валидатор классификатора, монитор новых RVT.

## Фаза 7. Эксплуатация
- SLA, метрики, регресс‑тесты.

> Для каждой задачи ведите DoD и тесты в `/docs/04.acceptance.md`.
